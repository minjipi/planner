<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Plan">
    <link rel="apple-touch-icon" href="icon-192.png">

    <title>My Plan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        :root {
            --active-bg: #6366f1;
            --card-bg: rgba(99, 102, 241, 0.05);
            --card-border: rgba(99, 102, 241, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
            -webkit-tap-highlight-color: transparent;
        }


        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
            border-radius: 9999px;
            transition: all 0.2s;
        }

        /* 1. ì„ íƒëœ ë‚ ì§œ ë°°ê²½ìƒ‰ ë³€ê²½ (ë³€ìˆ˜ ì—°ë™) */
        .active-day {
            background: var(--active-bg) !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 2. Monthly Goals ì¹´ë“œ ë°°ê²½ìƒ‰ ë³€ê²½ (ë³€ìˆ˜ ì—°ë™) */
        .dynamic-card {
            background-color: var(--card-bg) !important;
            border: 1px solid var(--card-border) !important;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-hidden {
            transform: translateX(-100%);
        }

        .dynamic-bg {
            transition: background 0.5s ease;
            background-size: cover;
            background-position: center;
        }

        .day-badge {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .day-badge.selected {
            background: black;
            color: white;
            border-color: black;
        }

        #dropZone.drag-over {
            border-color: var(--active-bg);
            background: var(--card-bg);
        }

        [contenteditable]:empty:before {
            content: attr(placeholder);
            color: #cbd5e1;
            cursor: text;
        }

        #noteInput:focus {
            outline: none;
        }

        #noteInput ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }

        #noteInput ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
        }

        .note-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen relative overflow-x-hidden">
    <div id="taskModal"
        class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-5">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <span id="modalType"
                    class="text-[10px] font-bold px-2 py-0.5 rounded bg-gray-100 text-gray-600 uppercase">GOAL</span>
                <button onclick="closeModal()" class="text-gray-400 hover:text-black"><i
                        class="fas fa-times"></i></button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <input type="text" id="modalEmoji"
                    class="w-12 text-center text-2xl border-none outline-none focus:ring-0 bg-gray-50 rounded-lg p-1"
                    placeholder="ğŸ“">
                <input type="text" id="modalTitleText"
                    class="flex-1 text-lg font-bold text-gray-900 border-none outline-none focus:ring-0"
                    placeholder="ëª©í‘œ íƒ€ì´í‹€">
            </div>
            <p id="modalTime" class="text-xs text-gray-400 mb-4 font-medium"></p>
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">ìƒì„¸ ë‚´ìš©</label>
                <textarea id="modalDetail"
                    class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl text-sm focus:outline-none focus:border-black transition h-32"
                    placeholder="ê´€ë ¨ ë‚´ìš©ì„ ê¸°ì…í•˜ì„¸ìš” (ì˜ˆ: Array ê°œë… ê³µë¶€)"></textarea>
            </div>
            <div class="flex space-x-2">
                <button onclick="saveModalChanges()"
                    class="flex-1 py-3 bg-black text-white rounded-xl font-bold text-sm hover:bg-gray-800 transition">ìˆ˜ì •
                    ì™„ë£Œ</button>
                <button id="modalDeleteBtn" onclick="deleteTaskFromModal()"
                    class="p-3 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition"><i
                        class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </div>

    <header
        class="max-w-md mx-auto md:max-w-4xl w-full bg-white/90 backdrop-blur-md sticky top-0 z-40 px-6 py-4 flex items-center shadow-sm border-b border-gray-100">
        <button onclick="toggleSidebar()" class="text-gray-800 hover:text-indigo-600 transition text-xl"><i
                class="fas fa-bars"></i></button>
        <h2 id="headerTitle" class="ml-4 font-bold text-gray-900 tracking-tighter text-lg uppercase">ADVANCED PLANNER
        </h2>
    </header>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/40 z-50 hidden"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-white z-50 shadow-2xl sidebar-hidden p-6">
        <div class="flex justify-between items-center mb-10">
            <span class="text-xl font-black text-indigo-600">MENU</span>
            <button onclick="toggleSidebar()" class="text-gray-400 hover:text-black"><i
                    class="fas fa-times"></i></button>
        </div>
        <nav class="space-y-2">
            <button onclick="showPage('main')"
                class="w-full flex items-center space-x-4 p-3 rounded-xl hover:bg-gray-100 transition text-gray-700"><i
                    class="fas fa-calendar-alt w-6 text-blue-500"></i><span class="font-medium">ë©”ì¸ í”Œë˜ë„ˆ</span></button>
            <button onclick="showPage('goal')"
                class="w-full flex items-center space-x-4 p-3 rounded-xl hover:bg-gray-100 transition text-gray-700"><i
                    class="fas fa-bullseye w-6 text-red-500"></i><span class="font-medium">ì¼ì •/ëª©í‘œ ë“±ë¡</span></button>
            <button onclick="showPage('note')"
                class="w-full flex items-center space-x-4 p-3 rounded-xl hover:bg-gray-100 transition text-gray-700"><i
                    class="fas fa-sticky-note w-6 text-yellow-500"></i><span class="font-medium">í”„ë¡œì íŠ¸ ë©”ëª¨</span></button>
            <button onclick="showPage('settings')"
                class="w-full flex items-center space-x-4 p-3 rounded-xl hover:bg-gray-100 transition text-gray-700"><i
                    class="fas fa-cog w-6 text-gray-500"></i><span class="font-medium">ì„¤ì •</span></button>
        </nav>
    </div>

    <main id="mainPage"
        class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col md:max-w-4xl md:flex-row relative">
        <div class="w-full md:w-1/2 p-6 bg-white border-r border-gray-100 flex flex-col">
            <div class="flex-grow">
                <div class="flex items-center justify-between mb-6">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i
                            class="fas fa-chevron-left text-xs"></i></button>
                    <h1 class="text-lg font-black text-gray-900" id="currentMonth"></h1>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition"><i
                            class="fas fa-chevron-right text-xs"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-[11px] mb-4 font-bold text-gray-400 uppercase">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                </div>
                <div class="grid grid-cols-7 gap-y-2 text-center" id="calendarDays"></div>

                <div id="goalsCard" class="mt-12 p-5 dynamic-card rounded-2xl">
                    <div class="flex justify-between items-end mb-3">
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-tighter">Monthly Goals</p>
                            <h4 class="text-sm font-bold text-gray-900">ì´ë‹¬ì˜ ëª©í‘œ ë‹¬ì„±ë¥ </h4>
                        </div>
                        <span id="mainGoalPercent" class="text-lg font-black text-gray-900">0%</span>
                    </div>
                    <div class="w-full bg-white/50 rounded-full h-2 overflow-hidden">
                        <div id="mainGoalBar" class="bg-black h-full transition-all duration-700" style="width: 0%">
                        </div>
                    </div>
                    <p id="mainGoalSummary" class="text-[10px] text-gray-500 mt-3 font-medium text-center">ëª©í‘œë¥¼ ë“±ë¡í•´ ë³´ì„¸ìš”!
                    </p>
                </div>
            </div>
            <div class="mt-auto"></div>
        </div>
        <div id="rightPanel"
            class="w-full md:w-1/2 p-8 text-gray-800 overflow-y-auto no-scrollbar h-[50vh] md:h-auto bg-gray-50 border-l border-gray-100 dynamic-bg">
            <div class="mb-10 bg-white/40 backdrop-blur-md p-6 rounded-3xl inline-block shadow-sm">
                <span class="text-7xl font-black text-gray-900 tracking-tighter" id="selectedDayLabel"></span>
                <p class="text-lg font-bold text-gray-600 uppercase tracking-widest mt-1" id="selectedMonthYearLabel">
                </p>
            </div>
            <div class="space-y-3" id="taskList"></div>
        </div>
    </main>

    <section id="notePage" class="hidden max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col md:max-w-4xl">
        <div
            class="w-full bg-white border-b border-gray-200 px-4 py-2 flex items-center space-x-4 overflow-x-auto no-scrollbar sticky top-0 z-10">
            <div class="flex items-center space-x-4 border-r border-gray-200 pr-4 text-gray-500 text-sm">
                <button onclick="formatDoc('bold')" class="hover:text-black p-1"><i class="fas fa-bold"></i></button>
                <button onclick="formatDoc('underline')" class="hover:text-black p-1"><i
                        class="fas fa-underline"></i></button>
                <button onclick="formatDoc('insertUnorderedList')" class="hover:text-black p-1"><i
                        class="fas fa-list-ul"></i></button>
            </div>
            <div class="flex-grow"></div>
            <div id="editorActions" class="flex items-center space-x-2">
                <button id="cancelEditBtn" onclick="resetEditor()"
                    class="hidden text-gray-400 hover:text-gray-600 px-3 py-1.5 text-sm font-medium transition">ì·¨ì†Œ</button>
                <button id="saveNoteBtn" onclick="saveNote()"
                    class="bg-[#03C75A] text-white px-4 py-1.5 rounded text-sm font-bold hover:bg-[#02b351] transition">ë°œí–‰</button>
            </div>
        </div>
        <div id="editorContainer" onclick="expandEditor(event)"
            class="bg-white p-8 md:p-12 transition-all duration-500 ease-in-out cursor-text border-b border-gray-50"
            style="height: 200px; overflow: hidden;">
            <div class="max-w-2xl mx-auto">
                <input type="text" id="noteTitle" onclick="event.stopPropagation()"
                    onmousedown="event.stopPropagation()"
                    class="w-full text-2xl font-bold border-none outline-none placeholder-gray-300 mb-4 bg-transparent"
                    placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <div class="w-full h-[1px] bg-gray-100 mb-6"></div>
                <div id="noteInput" contenteditable="true"
                    class="w-full h-full text-base border-none outline-none leading-relaxed min-h-[100px]"
                    placeholder="ê¸€ê°ê³¼ í•¨ê»˜ ë‚˜ì˜ ì¼ìƒì„ ê¸°ë¡í•´ë³´ì„¸ìš”!"></div>
            </div>
        </div>
        <div class="flex-grow overflow-y-auto bg-gray-50 p-8">
            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-6 flex items-center"><i
                    class="fas fa-list-ul mr-2"></i>Saved Notes</h3>
            <div id="noteList" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </section>

    <section id="goalPage" class="hidden max-w-md mx-auto bg-white min-h-screen shadow-2xl p-8 md:max-w-4xl">
        <h1 class="text-3xl font-black text-gray-900 mb-8 tracking-tighter uppercase">Add Schedule</h1>

        <div class="space-y-6">
            <div class="flex p-1 bg-gray-100 rounded-xl">
                <button id="typeGoal" onclick="setTaskType('goal')"
                    class="flex-1 py-3 rounded-lg font-bold transition bg-white shadow-sm text-black">ğŸ¯ ëª©í‘œ</button>
                <button id="typeSched" onclick="setTaskType('sched')"
                    class="flex-1 py-3 rounded-lg font-bold transition text-gray-400">ğŸ“… ì¼ì •</button>
            </div>

            <div class="flex gap-4">
                <input type="text" id="taskEmoji"
                    class="w-16 p-4 bg-gray-50 border border-gray-100 rounded-xl text-center text-2xl" value="ğŸ“">
                <input type="text" id="taskInput"
                    class="flex-1 p-4 bg-gray-50 border border-gray-100 rounded-xl focus:outline-none focus:border-black transition"
                    placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Time</label>
                    <input type="time" id="timeInput" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-xl">
                </div>
                <div id="singleDateWrapper">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Date</label>
                    <input type="date" id="dateInput" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-xl">
                </div>
            </div>

            <div class="p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-bold text-gray-500 uppercase">ë§¤ì£¼ ë°˜ë³µ (Weekly Repeat)</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="repeatToggle" class="sr-only peer" onchange="toggleRepeatUI()">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:bg-black after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all">
                        </div>
                    </label>
                </div>
                <div id="daySelector"
                    class="flex justify-between gap-1 opacity-20 pointer-events-none transition-opacity">
                    <div class="day-badge" onclick="toggleDay(0)" data-day="0">ì¼</div>
                    <div class="day-badge" onclick="toggleDay(1)" data-day="1">ì›”</div>
                    <div class="day-badge" onclick="toggleDay(2)" data-day="2">í™”</div>
                    <div class="day-badge" onclick="toggleDay(3)" data-day="3">ìˆ˜</div>
                    <div class="day-badge" onclick="toggleDay(4)" data-day="4">ëª©</div>
                    <div class="day-badge" onclick="toggleDay(5)" data-day="5">ê¸ˆ</div>
                    <div class="day-badge" onclick="toggleDay(6)" data-day="6">í† </div>
                </div>
            </div>

            <button onclick="addTask()"
                class="w-full py-5 bg-black text-white font-bold rounded-2xl hover:bg-gray-800 transition shadow-xl text-lg">ê¸°ë¡í•˜ê¸°</button>

            <button onclick="showPage('main')"
                class="w-full py-4 text-gray-400 font-bold text-sm uppercase tracking-widest">Cancel</button>

            <div class="mt-10">
                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-4">ìµœê·¼ ë“±ë¡ëœ ëª©ë¡ (í´ë¦­í•˜ì—¬ ìƒì„¸ì…ë ¥)</h3>
                <div id="liveTaskList" class="space-y-3"></div>
            </div>
        </div>
    </section>

    <section id="settingsPage" class="hidden max-w-md mx-auto bg-white min-h-screen shadow-2xl p-8 md:max-w-4xl">
        <h1 class="text-3xl font-black text-gray-900 mb-8 tracking-tighter uppercase">Settings</h1>
        <div class="bg-white rounded-3xl p-8 border border-gray-200 shadow-sm mb-6">
            <h3 class="font-bold text-gray-800 mb-2">í”Œë˜ë„ˆ íƒ€ì´í‹€ ë³€ê²½</h3>
            <div class="flex gap-2">
                <input type="text" id="titleInput" maxlength="49"
                    class="flex-1 p-3 bg-gray-50 border border-gray-100 rounded-xl focus:outline-none focus:border-black transition text-sm"
                    placeholder="ìƒˆë¡œìš´ íƒ€ì´í‹€ ì…ë ¥">
                <button onclick="updateTitle()"
                    class="px-6 py-3 bg-black text-white text-xs font-bold rounded-xl hover:bg-gray-800 transition uppercase tracking-widest">Update</button>
            </div>
        </div>
        <div class="bg-white rounded-3xl p-8 border border-gray-200 shadow-sm">
            <h3 class="font-bold text-gray-800 mb-2">ì§€ëŠ¥í˜• ë°°ê²½ ê·¸ë¼ë°ì´ì…˜</h3>
            <div id="dropZone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                ondrop="handleDrop(event)"
                class="flex flex-col items-center justify-center border-2 border-dashed border-gray-200 rounded-3xl p-16 bg-gray-50 transition-all cursor-pointer">
                <input type="file" id="imageInput" accept="image/*" class="hidden"
                    onchange="processImage(this.files[0])">
                <label for="imageInput" class="cursor-pointer flex flex-col items-center"><i
                        class="fas fa-magic text-5xl text-indigo-400 mb-5"></i><span
                        class="text-sm font-black text-gray-600">ì´ë¯¸ì§€ ì—…ë¡œë“œ (Click or Drag)</span></label>
            </div>
            <button onclick="resetBackground()"
                class="mt-8 w-full py-4 rounded-xl bg-gray-100 text-gray-500 font-bold hover:bg-black hover:text-white transition uppercase text-xs tracking-widest">Reset
                to Default</button>
        </div>
    </section>

    <canvas id="colorCanvas" class="hidden"></canvas>

    <script>
        let tasks = JSON.parse(localStorage.getItem('myTasks')) || {};
        let notes = JSON.parse(localStorage.getItem('myNotes')) || [];
        let userBg = localStorage.getItem('userBg') || 'linear-gradient(to bottom, #ffffff, #f3f4f6)';
        let userTitle = localStorage.getItem('userTitle') || 'ADVANCED PLANNER';
        let taskType = 'goal';
        let selectedRepeatDays = [];
        let editingNoteId = null;
        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ì¸ë±ìŠ¤ ê´€ë¦¬
        let currentEditDate = null;
        let currentEditIdx = null;

        const today = new Date();
        let currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
        let selectedDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const monthNames = ["01.", "02.", "03.", "04.", "05.", "06.", "07.", "08.", "09.", "10.", "11.", "12."];

        window.onload = () => {
            applyBackground(userBg);
            applyTitle(userTitle);
            renderCalendar();
            renderNotes();
            document.getElementById('dateInput').valueAsDate = new Date();
        };

        function updateTitle() {
            const input = document.getElementById('titleInput');
            const newTitle = input.value.trim();
            if (newTitle.length === 0 || newTitle.length >= 50) return alert("ì…ë ¥ê°’ ì˜¤ë¥˜");
            userTitle = newTitle;
            localStorage.setItem('userTitle', userTitle);
            applyTitle(userTitle);
            input.value = "";
            alert("ë³€ê²½ë¨");
        }

        function applyTitle(text) { document.getElementById('headerTitle').innerText = text; }

        function showPage(page) {
            const ids = ['mainPage', 'goalPage', 'settingsPage', 'notePage'];
            ids.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(page + 'Page').classList.remove('hidden');
            if (page === 'main') renderCalendar();
            if (page === 'note') renderNotes();
            if (page === 'goal') renderLiveTaskList();
            toggleSidebar(false);
        }

        function toggleSidebar(force) {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (force === false) { sb.classList.add('sidebar-hidden'); overlay.classList.add('hidden'); }
            else { sb.classList.toggle('sidebar-hidden'); overlay.classList.toggle('hidden'); }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            document.getElementById('currentMonth').innerText = `${monthNames[month]} ${year}`;
            const calendarDays = document.getElementById('calendarDays'); calendarDays.innerHTML = '';
            const firstDay = new Date(year, month, 1).getDay(); const lastDate = new Date(year, month + 1, 0).getDate();
            const lastDatePrev = new Date(year, month, 0).getDate();
            for (let i = firstDay; i > 0; i--) {
                const d = document.createElement('div'); d.className = 'calendar-day text-gray-200 text-xs cursor-default'; d.innerText = lastDatePrev - i + 1; calendarDays.appendChild(d);
            }
            for (let i = 1; i <= lastDate; i++) {
                const d = document.createElement('div'); const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                d.className = `calendar-day text-sm font-semibold hover:bg-gray-100`; d.innerText = i;
                if (tasks[dateKey]?.length > 0) {
                    const dot = document.createElement('div'); dot.className = `absolute bottom-1 w-1 h-1 rounded-full bg-black/20`; d.appendChild(dot);
                }
                if (i === selectedDate.getDate() && month === selectedDate.getMonth() && year === selectedDate.getFullYear()) d.classList.add('active-day');
                d.onclick = () => { selectedDate = new Date(year, month, i); renderCalendar(); };
                calendarDays.appendChild(d);
            }
            updateTaskDisplay();
            updateProgress();
        }

        function updateTaskDisplay() {
            const dateKey = getDateKey(selectedDate);
            const taskList = document.getElementById('taskList');
            let currentTasks = tasks[dateKey] || [];
            taskList.innerHTML = '';
            document.getElementById('selectedDayLabel').innerText = selectedDate.getDate();
            document.getElementById('selectedMonthYearLabel').innerText = `${monthNames[selectedDate.getMonth()]} ${selectedDate.getFullYear()}`;

            if (currentTasks.length === 0) {
                taskList.innerHTML = '<p class="text-gray-400 text-center py-20 font-bold tracking-widest text-[10px] bg-white/30 rounded-3xl uppercase">Rest Day</p>';
            } else {
                currentTasks.forEach((task, idx) => {
                    const item = document.createElement('div');
                    item.className = `bg-white/80 backdrop-blur-md p-5 rounded-2xl flex items-center justify-between border border-gray-100 shadow-sm transition hover:scale-[1.02] cursor-pointer ${task.completed ? 'opacity-40' : ''}`;
                    item.onclick = () => openModal(dateKey, idx);

                    item.innerHTML = `
    <div class="flex items-center space-x-4">
        <button onclick="event.stopPropagation(); toggleTask('${dateKey}', ${idx})" class="w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-black border-black' : 'border-gray-200'} flex items-center justify-center transition">
            ${task.completed ? '<i class="fas fa-check text-white text-[10px]"></i>' : ''}
        </button>
        <div>
            <p class="font-bold text-gray-900 text-sm ${task.completed ? 'line-through' : ''}">${task.title}</p>
            <div class="flex flex-col space-y-1 mt-1">
                ${task.detail ? `<p class="text-[10px] text-gray-500 leading-tight">${task.detail.replace(/\n/g, '<br>')}</p>` : ''}
            </div>
        </div>
    </div>
    <div class="flex items-center space-x-4">
        <span class="text-[10px] font-black text-gray-400">${task.time}</span>
    </div>`;
                    taskList.appendChild(item);
                });
            }
        }

        function updateProgress() {
            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            let totalGoals = 0; let completedGoals = 0;
            Object.keys(tasks).forEach(key => {
                const [y, m, d] = key.split('-').map(Number);
                if (y === year && m === month + 1) {
                    tasks[key].forEach(t => { if (t.type === 'goal') { totalGoals++; if (t.completed) completedGoals++; } });
                }
            });
            const percent = totalGoals === 0 ? 0 : Math.round((completedGoals / totalGoals) * 100);
            document.getElementById('mainGoalPercent').innerText = percent + '%';
            document.getElementById('mainGoalBar').style.width = percent + '%';
            document.getElementById('mainGoalSummary').innerText = totalGoals === 0 ? "ì´ë‹¬ì˜ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤." : `${totalGoals}ê°œ ì¤‘ ${completedGoals}ê°œ ì™„ë£Œ`;
        }

        function setTaskType(type) {
            taskType = type;
            document.getElementById('typeGoal').className = type === 'goal' ? 'flex-1 py-3 rounded-lg font-bold transition bg-white shadow-sm text-black' : 'flex-1 py-3 rounded-lg font-bold transition text-gray-400';
            document.getElementById('typeSched').className = type === 'sched' ? 'flex-1 py-3 rounded-lg font-bold transition bg-white shadow-sm text-black' : 'flex-1 py-3 rounded-lg font-bold transition text-gray-400';
        }

        function toggleRepeatUI() {
            const isRepeat = document.getElementById('repeatToggle').checked;
            const selector = document.getElementById('daySelector');
            const dateInput = document.getElementById('singleDateWrapper');
            if (isRepeat) { selector.classList.remove('opacity-20', 'pointer-events-none'); dateInput.classList.add('opacity-20', 'pointer-events-none'); }
            else { selector.classList.add('opacity-20', 'pointer-events-none'); dateInput.classList.remove('opacity-20', 'pointer-events-none'); }
        }

        function toggleDay(day) {
            const el = document.querySelector(`[data-day="${day}"]`);
            if (selectedRepeatDays.includes(day)) { selectedRepeatDays = selectedRepeatDays.filter(d => d !== day); el.classList.remove('selected'); }
            else { selectedRepeatDays.push(day); el.classList.add('selected'); }
        }

        function addTask() {
            const title = document.getElementById('taskInput').value;
            const emoji = document.getElementById('taskEmoji').value;
            const time = document.getElementById('timeInput').value || "All Day";
            const isRepeat = document.getElementById('repeatToggle').checked;

            if (!title) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // ì‹ ê·œ: detail í•„ë“œ ì¶”ê°€ëœ ê°ì²´ ìƒì„± í•¨ìˆ˜
            const createTaskObj = () => ({
                title: `${emoji} ${title}`,
                time,
                completed: false,
                type: taskType,
                detail: "" // ìƒì„¸ ë‚´ìš© í•„ë“œ ì¶”ê°€
            });

            if (isRepeat) {
                if (selectedRepeatDays.length === 0) return alert("ë°˜ë³µí•  ìš”ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                const year = currentDate.getFullYear(); const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 1; i <= daysInMonth; i++) {
                    const loopDate = new Date(year, month, i);
                    if (selectedRepeatDays.includes(loopDate.getDay())) {
                        const key = getDateKey(loopDate);
                        if (!tasks[key]) tasks[key] = [];
                        tasks[key].push(createTaskObj());
                    }
                }
            } else {
                const dateVal = new Date(document.getElementById('dateInput').value);
                const key = getDateKey(dateVal);
                if (!tasks[key]) tasks[key] = [];
                tasks[key].push(createTaskObj());
            }
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            renderLiveTaskList();
            document.getElementById('taskInput').value = ""; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            alert("ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function toggleTask(dateKey, index) {
            tasks[dateKey][index].completed = !tasks[dateKey][index].completed;
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            updateTaskDisplay(); updateProgress();
        }

        function deleteTask(dateKey, index) {
            if (!confirm("ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            tasks[dateKey].splice(index, 1);
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            updateTaskDisplay(); renderCalendar();
        }

        function formatDoc(command) {
            document.execCommand(command, false, null);
        }

        function expandEditor(event) {
            const container = document.getElementById('editorContainer');
            container.style.height = '400px';
            container.style.overflow = 'auto';
            document.getElementById('noteInput').focus();
        }

        function resetEditor() {
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteInput').innerHTML = '';
            editingNoteId = null;
            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('saveNoteBtn').innerText = 'ë°œí–‰';
            const container = document.getElementById('editorContainer');
            container.style.height = '200px';
            container.style.overflow = 'hidden';
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteInput').innerHTML.trim();
            if (!title && !content) return alert("ì œëª© ë˜ëŠ” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const now = new Date();
            const dateStr = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;

            if (editingNoteId !== null) {
                const idx = notes.findIndex(n => n.id === editingNoteId);
                if (idx !== -1) {
                    notes[idx].title = title || 'ì œëª© ì—†ìŒ';
                    notes[idx].content = content;
                    notes[idx].date = dateStr;
                }
            } else {
                notes.unshift({
                    id: Date.now(),
                    title: title || 'ì œëª© ì—†ìŒ',
                    content,
                    date: dateStr
                });
            }

            localStorage.setItem('myNotes', JSON.stringify(notes));
            resetEditor();
            renderNotes();
        }

        function loadNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteInput').innerHTML = note.content;
            editingNoteId = id;
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('saveNoteBtn').innerText = 'ìˆ˜ì •';
            expandEditor();
        }

        function renderNotes() {
            const list = document.getElementById('noteList');
            if (!list) return;
            list.innerHTML = notes.map(n => `
                <div onclick="loadNote(${n.id})" class="note-card p-6 bg-white rounded-2xl border border-gray-100 shadow-sm relative group">
                    <span class="text-[10px] font-bold text-gray-300 uppercase block mb-2">${n.date}</span>
                    <h4 class="font-black text-gray-900 mb-2 truncate">${n.title}</h4>
                    <div class="text-xs text-gray-500 line-clamp-3">${n.content}</div>
                </div>
            `).join('');
        }

        function processImage(file) {
            if (!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('colorCanvas'); const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
                    const points = [[0.1, 0.1], [0.9, 0.1], [0.5, 0.5], [0.1, 0.9], [0.9, 0.9]];
                    const colors = points.map(p => { const data = ctx.getImageData(img.width * p[0], img.height * p[1], 1, 1).data; return `rgba(${data[0]}, ${data[1]}, ${data[2]}, 1)`; });
                    const gradient = `linear-gradient(135deg, ${colors[0].replace('1)', '0.4)')}, ${colors[4].replace('1)', '0.4)')})`;
                    applyBackground(gradient, colors[0]); localStorage.setItem('userBg', gradient);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function applyBackground(bg, themeColor = null) {
            document.getElementById('rightPanel').style.background = bg;

            // ìƒ‰ìƒ ì¶”ì¶œ ë˜ëŠ” ê¸°ë³¸ê°’ ì„¤ì •
            let color = themeColor;
            if (!color && bg.includes('rgba')) {
                color = bg.match(/rgba\([^)]+\)/)[0].replace('0.4', '1');
            } else if (!color) {
                color = '#6366f1'; // ê¸°ë³¸ ì¸ë””ê³ 
            }

            // CSS ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ì¹´ë“œì™€ ë‚ ì§œ ë²„íŠ¼ì— ì¦‰ì‹œ ë°˜ì˜)
            document.documentElement.style.setProperty('--active-bg', color);
            document.documentElement.style.setProperty('--card-bg', color.replace('1)', '0.1)'));
            document.documentElement.style.setProperty('--card-border', color.replace('1)', '0.2)'));
        }

        function resetBackground() {
            const defaultBg = 'linear-gradient(to bottom, #ffffff, #f3f4f6)';
            applyBackground(defaultBg, 'rgba(99, 102, 241, 1)');
            localStorage.setItem('userBg', defaultBg);
        }

        function getDateKey(date) { return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`; }
        function changeMonth(offset) { currentDate.setMonth(currentDate.getMonth() + offset); renderCalendar(); }
        function isEmoji(str) {
            const emojiRegex = /^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)$/u;
            return emojiRegex.test(str);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const emojiInput = document.getElementById('modalEmoji');
            emojiInput.addEventListener('input', () => {
                const val = emojiInput.value;
                if (val && !isEmoji(val)) {
                    const chars = [...val];
                    const lastEmoji = chars.reverse().find(c => isEmoji(c));
                    emojiInput.value = lastEmoji || '';
                }
            });
        });

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('drag-over'); }
        function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); processImage(e.dataTransfer.files[0]); }

        let currentEditingKey = null; // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ ë°ì´í„° í¬ì¸í„°

        function renderLiveTaskList() {
            const liveList = document.getElementById('liveTaskList');
            if (!liveList) return;

            // 1. ëª¨ë“  ë‚ ì§œì˜ íƒœìŠ¤í¬ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ìˆ˜ì§‘
            let allTasks = [];
            Object.keys(tasks).forEach(date => {
                tasks[date].forEach((task, index) => {
                    allTasks.push({ ...task, date, index });
                });
            });

            // 2. ì œëª©ê³¼ ì‹œê°„ì´ ê°™ì€ ì¼ì •ì€ í•˜ë‚˜ë§Œ ë‚¨ê¸°ê¸° (ì¤‘ë³µ ì œê±°)
            const uniqueTasks = [];
            const seen = new Set();

            // ìµœì‹  ë“±ë¡ìˆœìœ¼ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë°°ì—´ì„ ë’¤ì§‘ì–´ì„œ ì²˜ë¦¬
            allTasks.reverse().forEach(task => {
                const identifier = `${task.title}-${task.time}-${task.type}`;
                if (!seen.has(identifier)) {
                    seen.add(identifier);
                    uniqueTasks.push(task);
                }
            });

            // 3. í™”ë©´ ë Œë”ë§ (ìƒìœ„ 5ê°œë§Œ ë…¸ì¶œí•˜ê±°ë‚˜ ì „ì²´ ë…¸ì¶œ)
            liveList.innerHTML = uniqueTasks.slice(0, 5).map(task => `
        <div onclick="openModal('${task.date}', ${task.index})" 
             class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between cursor-pointer hover:bg-gray-50 transition">
            <div class="flex items-center space-x-3">
                <span class="text-lg">${task.title.split(' ')[0]}</span>
                <div>
                    <p class="text-sm font-bold text-gray-900">${task.title.split(' ').slice(1).join(' ')}</p>
                    <p class="text-[10px] text-gray-400 font-medium">${task.time}</p>
                </div>
            </div>
            <i class="fas fa-chevron-right text-gray-300 text-xs"></i>
        </div>
    `).join('');

            if (uniqueTasks.length === 0) {
                liveList.innerHTML = '<p class="text-center text-gray-300 text-xs py-4">ìµœê·¼ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        function updateDetailDirect(dateKey, index, val) {
            if (tasks[dateKey] && tasks[dateKey][index]) {
                tasks[dateKey][index].detail = val;
                localStorage.setItem('myTasks', JSON.stringify(tasks));

                // ë©”ì¸ í™”ë©´ ë¦¬ìŠ¤íŠ¸ê°€ ë„ì›Œì ¸ ìˆë‹¤ë©´ í•¨ê»˜ ê°±ì‹ 
                if (!document.getElementById('mainPage').classList.contains('hidden')) {
                    updateTaskDisplay();
                }
            }
        }

        // 2. ë©”ì¸ í™”ë©´ íŒì—… ëª¨ë‹¬ ì œì–´
        function openModal(dateKey, idx) {
            const task = tasks[dateKey][idx];
            currentEditDate = dateKey;
            currentEditIdx = idx;

            const parts = task.title.split(' ');
            document.getElementById('modalEmoji').value = parts[0] || '';
            document.getElementById('modalTitleText').value = parts.slice(1).join(' ');
            document.getElementById('modalDetail').value = task.detail || "";
            document.getElementById('modalTime').innerText = task.time;
            document.getElementById('modalType').innerText = task.type;

            document.getElementById('taskModal').classList.remove('hidden');
        }

        function deleteTaskFromModal() {
            if (currentEditDate === null || currentEditIdx === null) return;
            if (!confirm("ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            tasks[currentEditDate].splice(currentEditIdx, 1);
            localStorage.setItem('myTasks', JSON.stringify(tasks));
            updateTaskDisplay();
            renderCalendar();
            renderLiveTaskList();
            closeModal();
        }

        function closeModal() {
            document.getElementById('taskModal').classList.add('hidden');
            currentEditDate = null;
            currentEditIdx = null;
        }

        function saveModalChanges() {
            if (currentEditDate === null || currentEditIdx === null) return;

            // 1. ë°ì´í„° ì—…ë°ì´íŠ¸
            const emoji = document.getElementById('modalEmoji').value.trim();
            const titleText = document.getElementById('modalTitleText').value.trim();
            const newDetail = document.getElementById('modalDetail').value;

            tasks[currentEditDate][currentEditIdx].title = `${emoji} ${titleText}`;
            tasks[currentEditDate][currentEditIdx].detail = newDetail;

            // 2. LocalStorage ì €ì¥
            localStorage.setItem('myTasks', JSON.stringify(tasks));

            // 3. í™”ë©´ ì¦‰ì‹œ ê°±ì‹  (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
            updateTaskDisplay(); // ìš°ì¸¡ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            renderCalendar();    // ìº˜ë¦°ë” ì (dot) ìƒíƒœ ë“± ê°±ì‹ 
            renderLiveTaskList(); // ìµœê·¼ ë“±ë¡ ëª©ë¡ ê°±ì‹ 

            closeModal();
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì„±ê³µ!', reg))
                    .catch(err => console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }
    </script>
</body>

</html>